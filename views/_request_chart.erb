<script type="text/javascript">
  var requests = null;
  var dates = null;
  var one_day = 24 * 3600 * 1000;
  var series = <%= Chart.requests_by_uri_and_date(@requests, @dates) %>;

  $(window).load(function() {
    requests = $('.request');
    dates = findDates(); // cache the array
    var chart = new Highcharts.Chart({
      chart: {
        renderTo: 'chart',
        defaultSeriesType: 'column'
      },
      title: {
        text: 'Requests by Date'
      },
      tooltip: {
        formatter: function() {
          return '<b>' + Highcharts.dateFormat('%A %B %e, %Y', this.x) + '</b><br>' +
          this.y + ' requests for "' + this.series.name + '"';
        }
      },
      xAxis: {
        type: 'datetime'
      },
      yAxis: {
        title: {
          text: 'Requests'
        }
      },
      plotOptions: {
        column: {
          stacking: 'normal'
        }
      },
      series: series
    });
  });

  function chartSeries() {
    var uris = [];
    requests.each(function() {
      uri = $(this).attr('data-uri');
      if(uris.indexOf(uri) < 0) { uris.push(uri); } // add uri if it's not already in the array
    });
    var series = [];
    $.each(uris, function(index, uri) {
      s = {
        name: uri,
        pointInterval: one_day,
        pointStart: dates[0],
        data: requestsByDate(uri)
      };
      series.push(s);
    });
    return series;
  }

  function findDates() {
    var found_dates = [];
    $('.date').each(function() {
      var id = $(this).attr('id');
      found_dates.push(id);
    });
    found_dates.sort();
    var start_date = new Date(found_dates[0]);
    var end_date = new Date(found_dates[found_dates.length-1]);
    var day_count = (end_date - start_date) / one_day;
    var dates = []
    for(i = 0; i < day_count; i++) {
      var date = start_date;
      date.setDate(date.getDate() + i);
      dates.push(date);
    }
    return dates;
  }

  function requestsByDate(uri) {
    var a = [];
    for(date in dates) {
      a.push($('#'+dateToString(date)+' .request[data-uri='+uri+']').length);
    }
    return a;
  }

  function dateToString(date) {
    var s = date.getFullYear()+'-'+date.getMonth()+'-'+date.getDate()
    return s;
  }
</script>

